# Story 2.3: Admin User Management & RBAC Interface

## Status
Draft

## Story

**As a** System Administrator
**I want** comprehensive user management interface for the authentication system
**So that** I can manage users, roles, and permissions through secure admin UI

## Acceptance Criteria

1. **Admin Route Creation:** New `/admin` protected route with admin-only access
2. **User Administration:** Complete CRUD interface for users with role management
3. **Authentication Integration:** Full integration with verified auth APIs
4. **Role-Based Access:** New admin interface for roles and permissions
5. **Session Management:** User session monitoring and control dashboard
6. **Security Administration:** Password policies and security settings UI
7. **Audit Integration:** User activity monitoring and logs display
8. **Built-in Admin Credential Management:** K8s Secret-based admin credential storage with secure database sync

## Tasks / Subtasks

- [ ] **Admin Protected Route Implementation** (AC: 1)
  - [ ] Create `/admin` route with admin-only authentication middleware
  - [ ] Implement AdminLayout component with navigation and security features
  - [ ] Add admin route guards and permission validation
  - [ ] Create admin dashboard landing page with user management overview

- [ ] **User Management CRUD Interface** (AC: 2)
  - [ ] Create UserManagement page component with user list display
  - [ ] Implement CreateUser modal with form validation and API integration
  - [ ] Build EditUser interface with profile management and role assignment
  - [ ] Add DeleteUser confirmation workflow with cascade handling
  - [ ] Integrate with authenticated `/api/v1/auth/users` CRUD endpoints

- [ ] **Authentication API Integration** (AC: 3)
  - [ ] Implement UserManagementService with JWT-authenticated API calls
  - [ ] Create user data fetching and caching with error handling
  - [ ] Add real-time user status updates and session management
  - [ ] Integrate with existing authStore for admin permission validation

- [ ] **RBAC Management Interface** (AC: 4)
  - [ ] Create RoleManagement component for role CRUD operations
  - [ ] Implement PermissionMatrix component for role-permission assignment
  - [ ] Add Kubernetes RBAC integration for cluster-level permissions
  - [ ] Create RoleAssignment interface for user-role management

- [ ] **Session Management Dashboard** (AC: 5)
  - [ ] Build ActiveSessions component with real-time session monitoring
  - [ ] Implement SessionControl interface for session termination
  - [ ] Add session analytics with user activity tracking
  - [ ] Create SessionSettings for timeout and security configuration

- [ ] **Security Administration Panel** (AC: 6)
  - [ ] Create SecuritySettings component for password policies
  - [ ] Implement MFAManagement interface for multi-factor authentication setup
  - [ ] Add LoginRestrictions component for IP and time-based access controls
  - [ ] Build SecurityNotifications system for security event alerts

- [ ] **Audit Integration Interface** (AC: 7)
  - [ ] Create AuditDashboard with user activity logs display
  - [ ] Implement UserActivityLog component with filtering and search
  - [ ] Add audit trail export functionality for compliance reporting
  - [ ] Integrate with backend audit APIs for real-time monitoring

- [ ] **Built-in Admin Credential Management** (AC: 8)
  - [ ] **Security Cleanup Phase - Remove Hardcoded Credentials**
    - [ ] Remove hardcoded admin credentials from database scripts (003_seed_and_compliance.sql)
    - [ ] Remove hardcoded credentials from Makefile and deployment scripts
    - [ ] Audit entire codebase for any remaining hardcoded admin credentials (grep search)
    - [ ] Update all documentation references to remove hardcoded credential mentions
    - [ ] Create migration script to clean existing deployments of hardcoded credentials
  - [ ] **K8s Secret Implementation Phase**
    - [ ] Create AdminCredentialSyncService for K8s Secret ↔ Database bidirectional sync
    - [ ] Implement K8s Secret template for admin credentials as source of truth
    - [ ] Add admin password retrieval CLI command (ArgoCD-style kubectl access)
    - [ ] Build AdminCredentialSettings UI component for secure password management
    - [ ] Integrate credential sync with user management APIs and validation
    - [ ] Add credential sync monitoring, health checks, and audit logging
    - [ ] Implement credential rotation workflow with zero-downtime updates
    - [ ] Add emergency admin access recovery procedures and documentation
  - [ ] **Fresh Deployment Validation Phase**
    - [ ] Test clean database deployment without any hardcoded credentials
    - [ ] Validate admin user creation via K8s Secret bootstrap process only
    - [ ] Confirm admin password retrieval works via kubectl command
    - [ ] Test admin login functionality with auto-generated credentials
    - [ ] Validate credential sync service startup and health monitoring
    - [ ] Perform comprehensive security audit to confirm zero credential leakage

- [ ] **Container-First Development Workflow** (Epic Requirement)
  - [ ] **Security Build Process**
    - [ ] Update `make dev-rebuild-web` with admin interface security validation
    - [ ] Implement admin route security testing in deployed environment
    - [ ] Add RBAC permission testing for admin interface components
    - [ ] Validate admin authentication compliance in container deployment
  - [ ] **Container Build and Deploy**: `make dev-upgrade-web` with admin interface validations
    - [ ] Test admin interface access controls in deployed configuration
    - [ ] Validate user management API integration in containerized setup
    - [ ] Confirm RBAC management works in deployed Kubernetes environment
    - [ ] Verify session management persistence across container restarts
    - [ ] **Clean Deployment Testing for Admin Credentials (AC: 8)**
      - [ ] Deploy from scratch with clean database (no hardcoded credentials)
      - [ ] Validate K8s Secret-based admin user bootstrap process
      - [ ] Test first-time admin access via auto-generated credentials
      - [ ] Confirm kubectl admin password retrieval command works
      - [ ] Verify credential sync service health and monitoring
      - [ ] Perform security scan to ensure zero hardcoded credential exposure

## Dev Notes

### Critical Implementation Context

Building on **Story 2.1 Authentication Foundation** and **Story 2.2 Chat Interface**, this story creates the missing administrative interface for the enterprise-ready authentication system.

**Implementation Foundation Requirements:**
- Complete integration with established JWT authentication from Stories 2.1-2.2
- Admin role validation using existing authStore and user permission system
- Protected route access with role-based authentication guards
- Full integration with verified backend authentication APIs

### Verified Backend API Integration

Based on Epic 2 backend verification [Source: epic-2-ollama-intigration-enterprise-frontend-ai.md#verified-implementation-requirements], the following authenticated admin APIs are confirmed available for integration:

**Primary Authentication APIs (VERIFIED):**
- `GET /api/v1/auth/users` - Retrieve all users with admin permissions ✅
- `POST /api/v1/auth/users` - Create new users with role assignment ✅
- `PUT /api/v1/auth/users/{userId}` - Update user profile and permissions ✅
- `DELETE /api/v1/auth/users/{userId}` - Delete user with cascade handling ✅
- `GET /api/v1/auth/sessions` - List active user sessions ✅
- `DELETE /api/v1/auth/sessions/{sessionId}` - Terminate specific user session ✅
- `GET /api/v1/auth/roles` - Retrieve available roles and permissions ✅
- `POST /api/v1/auth/roles` - Create custom roles with permission sets ✅

### Component Architecture Integration

Based on established patterns [Source: docs/architecture/source-tree.md#frontend-file-structure]:

**Admin Interface Component Structure:**
```typescript
// Admin Interface Component Structure
src/pages/admin/
├── index.tsx                  # Admin dashboard landing page
├── users/                     # User management section
│   ├── index.tsx             # User list and management
│   ├── create.tsx            # Create user form
│   ├── [userId]/edit.tsx     # Edit user profile
│   └── components/           # User-specific components
├── roles/                     # RBAC management section
│   ├── index.tsx             # Role management interface
│   ├── permissions.tsx       # Permission matrix management
│   └── components/           # Role-specific components
├── sessions/                  # Session management section
│   ├── index.tsx             # Active sessions dashboard
│   └── components/           # Session management components
├── security/                  # Security administration
│   ├── index.tsx             # Security settings panel
│   ├── policies.tsx          # Password and security policies
│   └── audit.tsx             # Audit and compliance logs
└── components/               # Shared admin components
    ├── AdminLayout.tsx       # Admin page layout wrapper
    ├── AdminNavigation.tsx   # Admin-specific navigation
    └── PermissionGuard.tsx   # Admin permission validation
```

### Built-in Admin Credential Management Architecture

**Enterprise-Grade K8s Secret Integration (AC: 8):**

Following the ArgoCD pattern for secure admin credential management, KubeChat implements a comprehensive K8s Secret-based credential management system that maintains SOC 2 Type II, GDPR, and enterprise security compliance.

**Admin Credential Architecture Overview:**
```typescript
// Security-compliant Admin Credential Management
interface SecureAdminCredentialManager {
  // K8s Secret as Single Source of Truth (SOC 2 Compliance)
  k8sSecret: {
    name: "kubechat-admin-secret"
    namespace: "kubechat-system"
    encryptionAtRest: true              // K8s etcd encryption
    rotationPolicy: "90-days"           // Enterprise password policy
    accessAuditLog: true                // SOC 2 audit requirement
    keys: {
      admin_username: string            // Base64 encoded
      admin_password: string            // Base64 encoded, bcrypt-ready
      admin_email: string               // Base64 encoded
      password_created: string          // ISO timestamp
      password_expires: string          // ISO timestamp
      last_rotation: string             // ISO timestamp
      rotation_count: number            // Audit trail
    }
  }

  // Database Sync with Audit Trail (GDPR Compliance)
  databaseStorage: {
    table: "admin_users"
    auditTable: "admin_credential_audit"
    syncStatus: "synced" | "out_of_sync" | "rotation_pending"
    passwordPolicy: {
      minLength: 24                     // Enterprise standard
      complexity: "high"               // Special chars, numbers, mixed case
      historyCheck: 12                 // Previous passwords remembered
      maxAge: 90                       // Days until forced rotation
    }
  }

  // Bidirectional Sync Controller with Security Validation
  syncController: {
    watchSecretChanges(): Promise<void>        // K8s watch for manual updates
    watchPasswordExpiry(): Promise<void>       // Automated rotation monitoring
    syncSecretToDatabase(): Promise<void>      // Bootstrap & manual updates
    syncDatabaseToSecret(): Promise<void>      // UI-driven password changes
    validateCredentialCompliance(): Promise<SecurityAuditResult>
    rotateCredentials(): Promise<RotationResult>
    emergencyAccess(): Promise<EmergencyCredentials>
  }
}
```

**Security Compliance Implementation:**
```yaml
# K8s Secret Template with Enterprise Security
apiVersion: v1
kind: Secret
metadata:
  name: kubechat-admin-secret
  namespace: kubechat-system
  labels:
    app.kubernetes.io/component: admin-credentials
    security.compliance/framework: "soc2-gdpr"
    security.classification: "confidential"
  annotations:
    helm.sh/resource-policy: keep
    security.rotation/policy: "90-days"
    security.audit/required: "true"
    security.encryption/at-rest: "aes-256"
type: Opaque
data:
  # Auto-generated secure credentials (24+ chars, enterprise complexity)
  admin_username: {{ "admin" | b64enc }}                    # Static admin username
  admin_password: {{ randAlphaNum 32 | b64enc }}           # Secure random password
  admin_email: {{ "admin@kubechat.dev" | b64enc }}         # Admin contact email
  password_created: {{ now | unixEpoch | toString | b64enc }}  # Creation timestamp
  password_expires: {{ (now | dateModify "+90d") | unixEpoch | toString | b64enc }} # 90-day expiry
  last_rotation: {{ now | unixEpoch | toString | b64enc }}    # Last rotation time
  rotation_count: {{ "0" | b64enc }}                       # Rotation audit counter
```

**ArgoCD-Style Password Retrieval:**
```bash
# Secure admin password retrieval (SOC 2 audit logged)
kubectl get secret kubechat-admin-secret -n kubechat-system \
  -o jsonpath="{.data.admin_password}" | base64 -d

# Make target for convenience (with audit logging)
make get-admin-password  # Logs access attempt with user/timestamp
```

### Authentication Integration Architecture

Building on Story 2.1 authentication foundation [Source: docs/architecture/security.md#rbac-integration]:

**Admin Authorization Implementation:**
```typescript
// Admin Permission Validation Integration
interface AdminState {
  // Authentication Integration from Story 2.1
  authStore: AuthStore; // JWT token management and user context

  // Admin-specific functionality
  users: User[];
  roles: Role[];
  activeSessions: UserSession[];
  auditLogs: AuditEntry[];

  // Built-in Admin Credential Management (AC: 8)
  adminCredentials: {
    syncStatus: 'synced' | 'out_of_sync' | 'rotation_pending' | 'error';
    lastSync: Date;
    passwordExpiry: Date;
    rotationCount: number;
    complianceStatus: 'compliant' | 'non_compliant' | 'pending_review';
  };

  // Admin Actions with RBAC
  createUser: (userData: CreateUserRequest) => Promise<User>;
  updateUser: (userId: string, updates: UpdateUserRequest) => Promise<User>;
  deleteUser: (userId: string) => Promise<void>;
  assignRole: (userId: string, roleId: string) => Promise<void>;
  terminateSession: (sessionId: string) => Promise<void>;

  // Admin Credential Management Actions (AC: 8)
  rotateAdminPassword: (newPassword?: string) => Promise<CredentialRotationResult>;
  syncCredentials: () => Promise<CredentialSyncResult>;
  validateCredentialCompliance: () => Promise<ComplianceValidationResult>;
  getEmergencyAccess: (justification: string) => Promise<EmergencyAccessResult>;
}
```

### RBAC Integration Requirements

Based on security architecture [Source: docs/architecture/security.md#rbac-integration]:

**Kubernetes RBAC Integration:**
- Admin interface must validate permissions through Kubernetes SubjectAccessReview API
- Role assignments must create corresponding Kubernetes ServiceAccounts and RoleBindings
- Permission matrix UI must reflect actual Kubernetes RBAC capabilities
- Session management must integrate with Kubernetes token lifecycle

**RBAC Validation Patterns:**
```typescript
// RBAC Permission Validation (from Security Architecture)
interface RBACValidator {
  validateAction: (user: User, action: string, resource: string) => Promise<boolean>;
  createServiceAccount: (userId: string, roles: string[]) => Promise<void>;
  updateRoleBindings: (userId: string, roles: string[]) => Promise<void>;
  validateAdminAccess: (token: string) => Promise<boolean>;
}
```

### Security Requirements Integration

**Admin Interface Security [Source: docs/architecture/security.md#authentication-and-authorization]:**
- All admin operations must validate JWT tokens with admin role claims
- Admin UI must implement session timeout with automatic logout
- User management operations must include audit trail logging
- RBAC changes must be logged for compliance and security monitoring
- Admin interface must support multi-factor authentication validation

**Built-in Admin Credential Security (AC: 8) - Enterprise Compliance:**
- **Security Cleanup Requirements**: Complete removal of hardcoded credentials from codebase
- **Clean Deployment Validation**: Fresh deployment testing without any credential remnants
- **Migration Security**: Secure transition from hardcoded to K8s Secret-based credentials
- **SOC 2 Type II Compliance**: K8s Secret encryption at rest with audit trails
- **GDPR Compliance**: Admin credential lifecycle management with data retention policies
- **Enterprise Password Policy**: 24+ character minimum, 90-day rotation, complexity requirements
- **Zero-Downtime Rotation**: Automated credential rotation with service continuity
- **Emergency Access Procedures**: Secure admin recovery with multi-factor validation
- **Audit Trail Requirements**: All credential access/changes logged with timestamps
- **Separation of Duties**: K8s Secret management requires cluster admin permissions
- **Encryption Standards**: AES-256 encryption for secrets with secure key management

**Security Validation Requirements:**
- Password policies enforcement through UI validation
- Account lockout management with override capabilities
- Security event monitoring with real-time alerts
- Session hijacking prevention with IP and device validation
- **Admin Credential Monitoring**: Real-time sync status and expiry alerts
- **Compliance Validation**: Automated security policy enforcement
- **Access Control Validation**: K8s RBAC integration for credential management

### File Locations for Implementation

Based on established project structure [Source: docs/architecture/source-tree.md]:

```
apps/web/src/
├── pages/
│   └── admin/                       # 🎯 NEW: Admin pages with protected routes
│       ├── index.tsx               # Admin dashboard
│       ├── users/                  # User management pages
│       ├── roles/                  # RBAC management pages
│       ├── sessions/               # Session management pages
│       └── security/               # Security administration pages
├── components/
│   └── admin/                       # 🎯 NEW: Admin-specific components
│       ├── AdminLayout.tsx          # Admin layout wrapper
│       ├── UserManagement/          # User CRUD components
│       ├── RoleManagement/          # RBAC components
│       ├── SessionManagement/       # Session control components
│       └── SecurityManagement/      # Security policy components
├── services/
│   └── admin/                       # 🎯 NEW: Admin API services
│       ├── userManagementService.ts # User CRUD operations
│       ├── roleManagementService.ts # RBAC operations
│       ├── sessionService.ts        # Session management
│       ├── auditService.ts          # Audit and compliance
│       └── adminCredentialSyncService.ts # 🎯 NEW: K8s Secret ↔ DB sync (AC: 8)
├── stores/
│   ├── adminStore.ts               # 🎯 NEW: Admin state management
│   ├── userManagementStore.ts      # 🎯 NEW: User management state
│   ├── roleManagementStore.ts      # 🎯 NEW: RBAC state management
│   └── adminCredentialStore.ts     # 🎯 NEW: Admin credential sync state (AC: 8)
└── types/
    ├── admin.ts                    # 🎯 NEW: Admin-related types
    └── adminCredentials.ts         # 🎯 NEW: Admin credential management types (AC: 8)

# Infrastructure Files for Admin Credential Management (AC: 8)
infrastructure/
├── helm/kubechat/templates/
│   ├── admin-secret.yaml          # 🎯 NEW: K8s Secret template for admin credentials
│   └── admin-credential-sync-job.yaml # 🎯 NEW: Credential sync job for rotation
└── database/consolidated-scripts/
    └── 004_admin_credential_management.sql # 🎯 NEW: Admin credential tables
```

### Integration with Existing Authentication System

**Continuation from Story 2.1 and 2.2:**
- Leverages established JWT token management and validation
- Integrates with existing authStore for permission checking
- Extends authentication system with administrative capabilities
- Maintains security patterns established in previous stories

**Story Integration Points:**
- Uses authenticated API patterns from Story 2.2 chat integration
- Extends user interface patterns from Story 2.1 authentication
- Maintains container-first development workflow from Epic 2

### Performance Requirements

**Admin Interface Performance:**
- User list loading must complete in <2 seconds for 1000+ users
- Role assignment updates must have <1 second response time
- Session monitoring must update in real-time with <500ms latency
- Audit log searching must return results in <3 seconds for 10,000+ entries
- Admin interface must be responsive and accessible on desktop and tablet

### Security Compliance Integration

**Enterprise Security Standards [Source: docs/architecture/security.md#compliance-and-governance]:**
- SOC 2 Type II compliance with access controls and audit logging
- GDPR compliance with data subject rights management
- Password policy enforcement with complexity requirements
- Session security with automatic timeout and concurrent session limits
- **Built-in Admin Credential Compliance (AC: 8):**
  - K8s Secret-based credential management with encryption at rest
  - 90-day mandatory password rotation with automated expiry monitoring
  - Enterprise password complexity (24+ chars, mixed case, numbers, symbols)
  - Audit trail for all credential access and modifications
  - Emergency access procedures with multi-factor authentication
  - Compliance-ready reporting for SOC 2, GDPR, and enterprise audits

### Testing Requirements

**Testing Standards:**
Based on established framework [Source: docs/architecture/tech-stack.md#testing-framework]:

**Test File Locations:**
- **Unit Tests:** `apps/web/tests/components/admin/`
- **Integration Tests:** `apps/web/tests/integration/admin/`
- **E2E Tests:** `apps/web/tests/e2e/admin/`
- **Security Tests:** `apps/web/tests/security/admin/`

**Required Test Coverage:**
- Admin interface component unit tests (>90% coverage)
- User management API integration tests with authentication validation
- RBAC permission validation tests for role assignments
- Session management integration tests with real-time updates
- Security policy enforcement tests for admin operations
- Accessibility tests for admin interface compliance
- **Built-in Admin Credential Testing (AC: 8) - Security Critical:**
  - K8s Secret creation, encryption, and access control tests (>95% coverage)
  - Bidirectional credential sync service integration tests
  - Password rotation and expiry workflow validation tests
  - Emergency access procedure and MFA integration tests
  - Compliance audit trail generation and integrity tests
  - Security policy enforcement and violation detection tests

**Testing Frameworks:**
- **Vitest** for unit and integration tests
- **Testing Library** for React component testing
- **Playwright** for end-to-end admin workflows
- **Security Testing** for admin permission validation

## Testing

### Critical Security Migration Testing (AC: 8)

**Hardcoded Credential Elimination Validation:**
- **Pre-Migration Security Audit**: Comprehensive scan for all hardcoded credentials
- **Migration Process Testing**: Validation of clean transition workflow
- **Post-Migration Verification**: Security audit confirming zero credential leakage
- **Fresh Deployment Testing**: Complete system deployment from clean state
- **Bootstrap Process Validation**: K8s Secret-only admin user creation testing
- **Rollback Procedures**: Testing of emergency rollback with security validation

### Admin Interface Testing Requirements

**Authentication Integration Testing:**
- JWT token validation for all admin API calls
- Admin role verification and permission enforcement
- Session management and automatic timeout handling
- Multi-factor authentication integration for admin access
- **Built-in Admin Credential Integration Testing (AC: 8):**
  - **Clean Deployment Testing**: Fresh deployment without hardcoded credentials
  - **Bootstrap Process**: K8s Secret-based admin user creation validation
  - **Credential Retrieval**: kubectl command functionality testing
  - **Security Audit**: Comprehensive scan for credential leakage prevention
  - K8s Secret encryption at rest validation in etcd
  - Credential sync service startup and health monitoring
  - Password rotation workflow with zero-downtime validation
  - Emergency access MFA bypass procedures
  - Audit log generation for all credential operations
  - SOC 2 / GDPR compliance reporting integration

**User Management Functionality Testing:**
- User CRUD operations with proper API integration
- Role assignment and permission validation
- Session monitoring and termination functionality
- Security policy enforcement and validation

**RBAC Integration Testing:**
- Kubernetes RBAC validation and ServiceAccount management
- Permission matrix updates with real-time effect validation
- Role assignment workflow with cascade permission updates
- Admin permission inheritance and validation testing

**Security Testing Scenarios:**
- Admin privilege escalation prevention validation
- User management operation audit logging verification
- Session hijacking prevention with IP and device validation
- Password policy enforcement and account lockout management
- **Admin Credential Security Testing (AC: 8) - Enterprise Critical:**
  - **Hardcoded Credential Elimination**: Security audit for complete removal
  - **Clean Bootstrap Testing**: Fresh deployment with K8s Secret-only credentials
  - **Migration Security**: Validation of clean transition from hardcoded credentials
  - Unauthorized K8s Secret access attempt detection and prevention
  - Credential sync service failure and recovery scenario testing
  - Password policy violation detection and enforcement testing
  - Emergency access security bypass attempt monitoring
  - Audit log tampering detection and integrity validation
  - SOC 2 Type II / GDPR compliance scenario validation
  - Credential rotation failure and rollback procedure testing

**API Endpoint Integration Testing:**
- Verify all admin API endpoints function correctly with JWT authentication
- Test user management endpoints with proper role validation
- Validate session management APIs with admin permission checks
- Confirm audit logging integration for all admin operations
- Test error handling for all admin API failure scenarios

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-17 | 1.0 | Initial Story 2.3 creation for admin user management and RBAC interface | Bob (Scrum Master) |
| 2025-01-17 | 1.1 | Added AC 8: Built-in Admin Credential Management with K8s Secret integration | Sarah (Product Owner) |

---

*📝 Generated with [Claude Code](https://claude.ai/code)*

*Co-Authored-By: Bob (Scrum Master) <hello@kubechat.dev>*