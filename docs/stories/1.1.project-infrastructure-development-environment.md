# Story 1.1: Project Infrastructure and Development Environment

## Status
Draft

## Story
**As a** Developer  
**I want** a complete container-first development environment with Helm-based deployment  
**so that** I can develop KubeChat in a production-like environment using Rancher Desktop without any local processes

## Acceptance Criteria

1. Monorepo structure with Helm chart as the primary development and deployment method
2. Helm templates for local development including PostgreSQL and Redis dependencies
3. Rancher Desktop integration with development values.yaml for local cluster deployment
4. **No direct pnpm run dev or go run** - all development through Docker container builds and Helm deployment
5. Development Dockerfile optimized for Go hot-reload and React development builds
6. Helm values.yaml.dev for local development with appropriate resource limits and debug configurations
7. Makefile commands: `make dev-deploy`, `make dev-clean`, `make dev-logs`, `make dev-setup`, `make dev-rollback` for container-first workflow
8. Documentation emphasizing container-first development approach with Rancher Desktop setup instructions
9. **Automated Development Setup:** `make dev-setup` installs all prerequisites and validates environment
10. **Development Environment Validation:** Health checks for all required tools and services
11. **Rollback Procedures:** `make dev-rollback` restores previous working state
12. **Database Migration Support:** Development database setup with migration capabilities

## Tasks / Subtasks

- [ ] **Task 1: Create Complete Monorepo Structure** (AC: 1)
  - [ ] Set up apps/ directory with web/ and api/ subdirectories
  - [ ] Create packages/ directory with shared/, ui/, and config/ subdirectories
  - [ ] Set up infrastructure/ directory with helm/, docker/, scripts/, and k8s/ subdirectories
  - [ ] Create docs/, tests/, and .github/ directories
  - [ ] Add root-level configuration files (pnpm-workspace.yaml, Makefile, .gitignore)

- [ ] **Task 2: Frontend Development Container Setup** (AC: 4, 5)
  - [ ] Create apps/web/Dockerfile with multi-stage build for development
  - [ ] Set up Next.js 14+ with TypeScript 5.6+ configuration
  - [ ] Configure Tailwind CSS 3.4+ and Headless UI 2.1+
  - [ ] Implement hot-reload capability in development container
  - [ ] Create apps/web/.dockerignore with proper exclusions

- [ ] **Task 3: Backend Development Container Setup** (AC: 4, 5)
  - [ ] Create apps/api/Dockerfile with multi-stage build for development
  - [ ] Set up Go 1.23+ with Gin 1.10+ framework
  - [ ] Configure client-go v0.30+ for Kubernetes integration
  - [ ] Implement hot-reload using air or similar tool
  - [ ] Create apps/api/.dockerignore with proper exclusions

- [ ] **Task 4: Helm Chart Development** (AC: 1, 2, 6)
  - [ ] Create infrastructure/helm/kubechat/Chart.yaml with dependencies
  - [ ] Develop Kubernetes templates for all services (deployment, service, configmap, secret)
  - [ ] Create values.yaml with production defaults
  - [ ] Create values-dev.yaml with development-specific configurations
  - [ ] Set up PostgreSQL and Redis as chart dependencies
  - [ ] Configure resource limits appropriate for local development

- [ ] **Task 5: Comprehensive Makefile Development** (AC: 7, 9, 11)
  - [ ] Implement `make dev-setup` with prerequisite installation and validation
  - [ ] Create `make dev-deploy` for complete stack deployment
  - [ ] Develop `make dev-clean` for environment cleanup
  - [ ] Implement `make dev-logs` for aggregated log viewing
  - [ ] Create `make dev-rollback` with state restoration
  - [ ] Add all additional commands: dev-status, dev-shell-api, dev-shell-web, dev-port-forward
  - [ ] Include database management commands: dev-db-connect, dev-db-migrate, dev-db-seed

- [ ] **Task 6: Database Infrastructure Setup** (AC: 2, 12)
  - [ ] Configure PostgreSQL 16+ in Helm chart with persistence
  - [ ] Set up Redis 7.4+ for caching and sessions
  - [ ] Create database migration framework setup
  - [ ] Implement database initialization and seeding scripts
  - [ ] Configure connection pooling and health checks

- [ ] **Task 7: Development Environment Validation** (AC: 9, 10)
  - [ ] Create prerequisite checking scripts (Docker, Kubernetes, Helm, kubectl, PNPM, Go)
  - [ ] Implement Rancher Desktop validation
  - [ ] Add storage class verification
  - [ ] Create service health check endpoints
  - [ ] Develop comprehensive `make dev-info` command

- [ ] **Task 8: Container-First Documentation** (AC: 8)
  - [ ] Write comprehensive README.md with setup instructions
  - [ ] Create CONTRIBUTING.md with development workflow
  - [ ] Document all Makefile commands with examples
  - [ ] Add troubleshooting guide for common issues
  - [ ] Include Rancher Desktop setup and verification steps

## Dev Notes

### Previous Story Insights
This is the first story of the project - no previous story context available.

### Source Tree Information
[Source: docs/architecture/source-tree.md]

**Complete Monorepo Structure Required:**
```
kubechat/
├── apps/                          # Application services
│   ├── web/                       # React TypeScript frontend
│   └── api/                       # Go backend services
├── packages/                      # Shared packages  
│   ├── shared/                    # Shared TypeScript types
│   ├── ui/                        # Component library
│   └── config/                    # Shared configuration
├── infrastructure/                # DevOps and deployment
│   ├── helm/                      # Kubernetes deployment charts
│   ├── docker/                    # Container configurations  
│   ├── scripts/                   # Build automation
│   └── k8s/                       # Raw Kubernetes manifests
├── docs/                          # Project documentation
├── tests/                         # Cross-service integration tests
├── .github/                       # GitHub configuration
├── pnpm-workspace.yaml           # PNPM workspace config
├── Makefile                      # Development commands
└── README.md                     # Project overview
```

### Technology Stack Requirements
[Source: docs/architecture/tech-stack.md]

**Required Technology Versions:**
- **Node.js:** 20+ for frontend tooling
- **TypeScript:** 5.6+ for type-safe development
- **React:** 18.3+ with Next.js 14+
- **Go:** 1.23+ for backend services
- **Gin:** 1.10+ HTTP web framework
- **client-go:** v0.30+ for Kubernetes integration
- **PostgreSQL:** 16+ primary database
- **Redis:** 7.4+ for caching and sessions
- **Helm:** 3.15+ for Kubernetes deployments
- **kubectl:** 1.28+ Kubernetes CLI

**Container-First Development Rules:**
- ❌ **Prohibited:** `pnpm run dev`, `go run`, direct database connections from host
- ✅ **Required:** All development through containers in Kubernetes, port-forwarding for access

### Development Environment Configuration
[Source: docs/architecture/deployment.md]

**Required Tools with Installation:**
| Tool | Version | Installation Command |
|------|---------|---------------------|
| **Docker** | Latest | Included with Rancher Desktop |
| **Kubernetes** | 1.28+ | Rancher Desktop |
| **Helm** | 3.15+ | `curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 \| bash` |
| **kubectl** | 1.28+ | Included with Rancher Desktop |
| **PNPM** | 8+ | `curl -fsSL https://get.pnpm.io/install.sh \| sh` |
| **Go** | 1.23+ | Download from https://go.dev/dl/ |

**Complete Makefile Commands Required:**
```bash
# Environment Management
make dev-info          # Show system information and prerequisites
make dev-setup         # Initial development environment setup  
make dev-clean         # Clean development environment

# Container Management
make dev-build         # Build all application containers
make dev-rebuild-api   # Rebuild API container only
make dev-rebuild-web   # Rebuild web container only
make dev-push          # Push containers to local registry

# Deployment Management
make dev-deploy        # Deploy complete development stack
make dev-upgrade       # Upgrade existing deployment
make dev-status        # Show deployment status
make dev-undeploy      # Remove development deployment
make dev-rollback      # Restore previous working state

# Development Tools
make dev-logs          # View aggregated application logs
make dev-logs-api      # View API service logs only
make dev-logs-web      # View web service logs only
make dev-shell-api     # Shell into API container
make dev-shell-web     # Shell into web container
make dev-port-forward  # Setup port forwarding for local access

# Database Management
make dev-db-connect    # Connect to development database
make dev-db-migrate    # Run database migrations
make dev-db-seed       # Seed development data
make dev-db-reset      # Reset database to clean state

# Testing
make dev-test          # Run all tests in containers
make dev-test-unit     # Run unit tests only
make dev-test-e2e      # Run end-to-end tests
```

**Port Forwarding Configuration:**
```bash
# Application Services
localhost:3001  -> kubechat-web       # Frontend application
localhost:8080  -> kubechat-api       # Backend API  
localhost:11434 -> ollama             # AI inference service

# Development Tools
localhost:5432  -> postgresql         # Database direct access
localhost:6379  -> redis              # Redis direct access
localhost:5050  -> pgadmin            # Database admin UI
localhost:8081  -> redis-commander    # Redis admin UI
```

### Coding Standards Requirements
[Source: docs/architecture/coding-standards.md]

**Critical Container-First Development Rules:**
- **Rule:** Never run `pnpm run dev` or `go run` locally - use containers only
- **Enforcement:** All development must happen through `make dev-deploy` and container access
- **File Organization:** Follow exact monorepo structure with proper naming conventions
- **Import Patterns:** Use proper TypeScript and Go import organization

**Security Requirements:**
- Use specific versions in Dockerfiles, never 'latest'
- Non-root user in all containers  
- Vulnerability scanning integration
- Container security best practices

### Rancher Desktop Validation Requirements
[Source: docs/architecture/deployment.md]

**Environment Verification Commands:**
```bash
# Check Kubernetes cluster status
kubectl cluster-info

# Verify nodes are ready  
kubectl get nodes

# Check available storage classes
kubectl get storageclass
```

**Expected Output Validation:**
- Kubernetes control plane at https://127.0.0.1:6443
- Node status: Ready with control-plane,master roles
- Storage class: local-path with rancher.io/local-path provisioner

### File Locations for Implementation
- **Root Makefile:** `/kubechat/Makefile`
- **Frontend Dockerfile:** `/kubechat/apps/web/Dockerfile`
- **Backend Dockerfile:** `/kubechat/apps/api/Dockerfile`
- **Main Helm Chart:** `/kubechat/infrastructure/helm/kubechat/`
- **Development Values:** `/kubechat/infrastructure/helm/kubechat/values-dev.yaml`
- **Scripts Directory:** `/kubechat/infrastructure/scripts/`
- **Documentation:** `/kubechat/README.md`, `/kubechat/CONTRIBUTING.md`

### Testing Requirements

**Testing Standards:**
[Source: docs/architecture/coding-standards.md]

**Testing Framework Requirements:**
- **Frontend:** Vitest 2.0+ and Testing Library 16+ for component testing
- **Backend:** Go testing package with Testify 1.9+ for assertions
- **E2E:** Playwright 1.47+ for end-to-end testing
- **Integration:** Cross-service integration tests in `/tests/` directory

**Test File Organization:**
```
tests/
├── unit/                         # Component/function level
├── integration/                  # Service integration  
├── e2e/                          # End-to-end scenarios
└── performance/                  # Load and performance
```

**Container Testing Requirements:**
- All tests must run inside containers
- Test commands integrated into Makefile
- Automated test execution in CI/CD pipeline
- Test results accessible through `make dev-test` commands

**Test File Locations:**
- **Frontend Tests:** `/kubechat/apps/web/tests/`
- **Backend Tests:** `/kubechat/apps/api/tests/`
- **Integration Tests:** `/kubechat/tests/integration/`
- **E2E Tests:** `/kubechat/tests/e2e/`

**Test Standards:**
- Component tests with proper mocking patterns
- Service tests with dependency injection
- Integration tests covering API endpoints
- Container-based test execution only

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-10 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*